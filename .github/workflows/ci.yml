name: Deploy PulseBoard Backend to AWS App Runner

on:
  push:
    branches:
      - main # Trigger deploy only when pushing to the main branch
  workflow_dispatch: # Allows manual run from GitHub Actions tab

env:
  AWS_REGION: us-east-1 # CRITICAL: MUST match your DB/MQ regions
  ECR_REPOSITORY: pulseboard-repo # Name for the container registry

jobs:
  # Job 1: Setup ECR Repository (runs only on first deployment)
  setup_ecr:
    runs-on: ubuntu-latest
    steps:
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Create ECR Repository if it doesn't exist
        id: create-repo
        run: |
          aws ecr describe-repositories --repository-names ${{ env.ECR_REPOSITORY }} || \
          aws ecr create-repository --repository-name ${{ env.ECR_REPOSITORY }}
    
  # Job 2: Build, Push, and Deploy ALL Services
  deploy_services:
    runs-on: ubuntu-latest
    needs: setup_ecr # Ensure ECR exists before trying to push containers
    strategy:
      matrix:
        # Define all backend services we need to build and deploy
        # Note: 'frontend' uses a separate Nginx build step, so we will deploy it as a service here.
        service: [activity-service, analytics-service, dashboard-api, frontend]
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Define Service Variables
        id: vars
        run: |
          # Determine the correct directory context for building the Docker image
          SERVICE_PATH="services/${{ matrix.service }}"
          if [ "${{ matrix.service }}" == "frontend" ]; then
            SERVICE_PATH="${{ matrix.service }}"
          fi
          echo "IMAGE_TAG=${{ github.sha }}" >> $GITHUB_OUTPUT
          echo "SERVICE_PATH=$SERVICE_PATH" >> $GITHUB_OUTPUT

      - name: Build and Push Docker Image
        uses: docker/build-push-action@v5
        with:
          context: ${{ steps.vars.outputs.SERVICE_PATH }}
          file: ${{ steps.vars.outputs.SERVICE_PATH }}/Dockerfile
          push: true
          tags: ${{ steps.login-ecr.outputs.registry }}/${{ env.ECR_REPOSITORY }}-${{ matrix.service }}:${{ steps.vars.outputs.IMAGE_TAG }}
          cache-from: type=gha

      - name: Deploy to AWS App Runner
        # --- THE FIX IS HERE ---
        uses: aws-actions/configure-apprunner@v1
        with:
          service-id: pulseboard-${{ matrix.service }} # Use a unique name for each service
          image-repository: ${{ steps.login-ecr.outputs.registry }}/${{ env.ECR_REPOSITORY }}-${{ matrix.service }}:${{ steps.vars.outputs.IMAGE_TAG }}
          aws-region: ${{ env.AWS_REGION }}
          
          # --- Environment Variables (Secrets) ---
          environment-variables: |
            POSTGRES_URL=${{ secrets.NEON_POSTGRES_URL }}
            REDIS_URL=${{ secrets.UPSTASH_REDIS_URL }}
            RABBITMQ_URL=${{ secrets.CLOUDAMQP_URL }}

          create-service-if-not-exists: true
